#!/usr/bin/env bash

# DESCRIPTION: Generate API model files from OpenAPI specification.
# USAGE: ./gen-api-model.sh <openapi-spec-file> <output-dir>

set -eou pipefail

cd "$(dirname "$0")/.." || exit 1

readonly _url=${1:-http://localhost:5050/openapi.json}

readonly _version=$(curl -s "$_url" | jq -r '.info.version')
readonly _timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
readonly _tmp_header=$(mktemp)


cat >"$_tmp_header" <<EOF
# ðŸ¤– Auto-generated by datamodel-codegen
#   version: ${_version}
#   timestamp: ${_timestamp}
# âš ï¸ Do not edit this file manually
EOF

echo "Generating API model files from OpenAPI specification..."
uv run datamodel-codegen --url "$_url" \
  --input-file-type openapi \
  --output ./polarsen/bot/models.py \
  --use-standard-collections \
  --enum-field-as-literal all \
  --target-python-version "$(cat .python-version)" \
  --output-model-type typing.TypedDict \
  --custom-file-header-path "$_tmp_header"

echo "API model files generated successfully in ./polarsen/bot/models.py"
