name: Release

on:
  # Auto pre-release on PR merge to master
  pull_request:
    types: [closed]
    branches: [master]

  # Manual release
  workflow_dispatch:
    inputs:
      bump_level:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: "minor"
      dry_run:
        description: "Run without committing or pushing"
        required: true
        type: boolean
        default: true
      prerelease:
        description: "Mark as pre-release (rc)"
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    # Only run on merged PRs or manual trigger
    if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true)
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup UV
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e # v6.8.0
        with:
          version: "latest"

      - name: Install Commitizen
        run: |
          uv sync --group bump

      - name: Determine release parameters
        id: params
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Auto-release on PR merge: patch + prerelease
            echo "bump_level=patch" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          else
            # Manual trigger: use inputs
            echo "bump_level=${{ github.event.inputs.bump_level }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          fi

      - name: Bump version & generate changelog
        id: cz
        run: |
          git config user.name "Polarsen bot"
          git config user.email "bot@polarsen.io"
          echo "ðŸ§ª Running Commitizen bump (dry-run=${{ steps.params.outputs.dry_run }}, prerelease=${{ steps.params.outputs.prerelease }})"

          PRERELEASE_FLAG=""
          if [[ "${{ steps.params.outputs.prerelease }}" == "true" ]]; then
            PRERELEASE_FLAG="--prerelease rc"
          fi

          if [[ "${{ steps.params.outputs.dry_run }}" == "true" ]]; then
            uv run cz -n cz_customize bump \
              --yes \
              --changelog \
              --no-verify \
              --template=.github/templates/CHANGELOG.md.j2 \
              --increment ${{ steps.params.outputs.bump_level }} \
              $PRERELEASE_FLAG \
              --dry-run
          else
            uv run cz -n cz_customize bump \
              --yes \
              --changelog \
              --no-verify \
              --template=.github/templates/CHANGELOG.md.j2 \
              --increment ${{ steps.params.outputs.bump_level }} \
              $PRERELEASE_FLAG
          fi

      - name: ðŸ§¾ Get new version
        id: get_version
        run: |
          echo "version=$(uv run cz version --project)" >> $GITHUB_OUTPUT
          echo "New version: $(uv run cz version --project)"


      - name: Push tags and changes
        if: steps.params.outputs.dry_run != 'true'
        run: |
          branch=$(git rev-parse --abbrev-ref HEAD)
          echo "Pushing changes and tags to branch: $branch"
          git push origin "$branch" --follow-tags

      - name: Generate GitHub Release
        if: steps.params.outputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: "Release ${{ steps.get_version.outputs.version }}"
          body_path: ${{ steps.params.outputs.prerelease == 'true' && 'RELEASE_NOTES.md' || 'CHANGELOG.md' }}
          prerelease: ${{ steps.params.outputs.prerelease == 'true' }}
