name: Release

on:
  # Auto pre-release on PR merge to master (after tests pass)
  workflow_run:
    workflows: ["Run Tests"]
    types: [completed]
    branches: [master]

  # Manual release
  workflow_dispatch:
    inputs:
      bump_level:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: "minor"
      dry_run:
        description: "Run without committing or pushing"
        required: true
        type: boolean
        default: true
      prerelease:
        description: "Mark as pre-release (rc)"
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    # Only run on successful test completion or manual trigger
    if: github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup UV
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e # v6.8.0
        with:
          version: "latest"

      - name: Install Commitizen
        run: |
          uv sync --group bump

      - name: Determine release parameters
        id: params
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            # Auto-release after tests pass on master: patch + prerelease
            echo "bump_level=patch" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          else
            # Manual trigger: use inputs
            echo "bump_level=${{ github.event.inputs.bump_level }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          fi

      - name: Bump version & generate changelog
        id: cz
        run: |
          git config user.name "Polarsen bot"
          git config user.email "bot@polarsen.io"
          echo "ðŸ§ª Running Commitizen bump (dry-run=${{ steps.params.outputs.dry_run }}, prerelease=${{ steps.params.outputs.prerelease }})"

          FLAGS=""
          if [[ "${{ steps.params.outputs.prerelease }}" == "true" ]]; then
            FLAGS="$FLAGS --prerelease rc"
          fi
          if [[ "${{ steps.params.outputs.dry_run }}" == "true" ]]; then
            FLAGS="$FLAGS --dry-run"
          fi

          uv run cz -n cz_customize bump \
            --yes \
            --no-verify \
            --increment ${{ steps.params.outputs.bump_level }} \
            $FLAGS

          if [[ "${{ steps.params.outputs.dry_run }}" != "true" ]]; then
            # Generate changelog only for final releases (not prereleases)
            if [[ "${{ steps.params.outputs.prerelease }}" != "true" ]]; then
              uv run cz -n cz_customize changelog --template=.github/templates/CHANGELOG.md.j2
              git add CHANGELOG.md
            fi

            # Update lock file after version bump
            uv lock
            git add uv.lock
            git commit --amend --no-edit --no-verify
          fi

      - name: ðŸ§¾ Get new version
        id: get_version
        run: |
          echo "version=$(uv run cz version --project)" >> $GITHUB_OUTPUT
          echo "New version: $(uv run cz version --project)"


      - name: Push tags and changes
        if: steps.params.outputs.dry_run != 'true'
        run: |
          branch=$(git rev-parse --abbrev-ref HEAD)
          echo "Pushing changes and tags to branch: $branch"
          git push origin "$branch" #  --follow-tags
          git push origin --tags

      - name: Generate GitHub Release
        if: steps.params.outputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: "Release ${{ steps.get_version.outputs.version }}"
          body_path: ${{ steps.params.outputs.prerelease == 'true' && 'RELEASE_NOTES.md' || 'CHANGELOG.md' }}
          prerelease: ${{ steps.params.outputs.prerelease == 'true' }}
